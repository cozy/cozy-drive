language: node_js
node_js:
  - '8'
env:
  global:
    - CXX=g++-4.8
    - MATTERMOST_CHANNEL=appvengers
    - secure: OLcPuglkDbRd9Xf8WmPAlAWTmdXDb+SNVc7+WKQjIap5Ej58BBTtaAYR8kzFKSWmvWWSnvKmOYJfOHvWIOfkzlwhGLnk/xUnCCsjWmWNjOmnL5x74gCbfEgyU+rIwr2c4/hpzjcywTVBIhL4l/Bxjn+Op+NepKYMNTKko9qB7fA+nDglX/t3VObC9kEXwXElOOgLHNpbfQLEJxdEqXm8hVMmfjA/wSQnX96GqWhKWqMMPyjAxwkxYXFa04AgeTV3C8y4x7YxiuaE8cKZfi+DYX8DyV0XdBVKJTBKTGEaTbotewmXf7F+zsZ6Rg46HvQskSmckMqMKzZfGLFKsVELt6wyNVdVwptWXfu9o2FrXvvHj1krOltN5kQPKLwSmQH4RSlekQ+JYpRN4e+w4dNazILk1pAMu7+EqBTdH5khkDxeA1LAfFVuZz3QP1/fczF/PXSMsaQa779XXKf8dsEP5S8dHjpCOLSI506E+sWa/tu1mSZoaL+jGPovhiygsPUjbjqUmim3Dz+22y2E8jGrEeIdTEcoDXrvjcqwSNvs2LXlgOtgjxP47Fb3Enk18BUpVL2LMTmwF8FbglfKOTOFHHuhT/lQjtptT6NBu0tKi8fcJ/jj3patUj2kbqo85FYext/VrPN42uIXkDCxu9bEnyaGkBpl3qgD7F0J/gJSa10=
    - secure: e7S5xeDOf5b18HEYMytTtFvy0GGtEq5KHc9eiydOXpWKhs1Lry/yOKPteJFN5fh6uHvlg02DCbANr2vvj0O8jn37eyudHowVsKJHXm4dEl9pe9Rbd1t6CwLwEb1qiI9juIlPt05nrlFKxrRzWEsC2mtk56FMfOhdKNf43O9VOJ9avxGk+6ztmo7iJjSZRRzRzqdw9NvS6yTAEZH0KHLxfIqXTppJU7vRDYRLpQLc7qJcAbiz2YuuINB0B8SzxhzuPADhxyxys8G8aurkbOYtJcFpUTBakRd8a9djP8r2+kuU5tb0OUOTnxBf3kETOD3B01kgGfd58tU6vt+zkD3sWZGpkKRjYXb7rPePDiPKrUx/OcTS8P7MO9+pwS5z3jocHIx3DNwPSUoVBj6mH7NBn8iEXHbMhWCZllNvTWmFCsTZKJsGky3smNz5nPf7/NOmJ5cdTcIY1jtSjRHzpkrBU22bd/8Jup1Z6YTsAuws/Hb5jVxV67ojjAHfFTR8JlBv8Nbb/0iux04ghcwcvbfPMFIe11PHs4OAvB/YKJGdEL58KCEMHc6XD51eFFir0M/94y8y2Cvq0loxO7TiiI+VdI9QALU5MRLiEMhMU/xdlVtUqfvCd4CcDLDr8tf+REwe8jUo7h7shgBdi9j7ioJYgB9oeJUJYv9gYVPdbXkpFd4=
    - secure: sbON3ZjGlkJTJPTHJGQwYw14sZgOT/mjzIUy8JxDRn+NIIzdrAJpqKM4ZJsfET6U+g+ZXWzn64y4cG3corwZ+Z03g1Bwb5oRq/if+cdXs68QWYkWZYUzGM9/JgvK3QFJ/3uH9KeEaO0aPtb2u2XdrDuXxGzTsQ0tRiC6E0Y7KokDczingLEy3BGqNgg7bZyhvDh9JGlmnB4tQC1+eTIq94Km+oaxrVqrK2Ch4qHPwjtI7aZ+bsZ9YQpQNEL5nzkCK7uAOJBh29FwAuo7Z5kanzinrSur2XiBpJa6pQ4DYc8bZqm41iRCqP1BsLsME7Om+veIBdGDzgyEIw15x9lNTvdRFdv65Lc0LfFs43cfL4s/Ikul1A0b8BetmFb9s+YJ276JUReyUHTC3+z4QIsMNAnBE+b/KgLSfv5rvV2pxuUwIyumqMZCrYt1kHi1KG3/j4FRkh+7svvGQanJuTMJ/rgT+Nh7HRUCzYPaQNL7adjJIfZPT7rvIUxL1mWWBBiOS2ijGDudzTD8stf3g85kjsBmgH1cTsxhj0rQ0P1+r67yNSzsRIU8R9LTMIbVp43x+1N89xF1YUQjjT8ul1Q0D4E1UhFr3UrZyzmhZ2dk3TK8cFrFUGi+qw+oPPJjw2xoN0sBnqOzVcUTnWg+pBEFya++CiIiVT61VjqKeEIU8mY= # REGISTRY TOKEN
    - secure: RUeeH+C5Yz3LKM/WX63NK79HnwSM3grulFbBKS4F6PZD4k1pnwV/T3pfqCcUZRvyWX7937aWqO4qD2kXRWd1T+I6wffA9H74SlsJcNFPWd6iBDGMh0uGTrJuUiimXd4hG2cFuRMF5dKmyn2P/2ncCcF3hgpntmoWVBj62YhD9CpbS/oxeUZluo4cHoQPaFvxLCYq7lLK372WCPpH2HwElkCL7lnPX1/ESJ+whgnwe+5g+XHWrsPkNIufqltBHz8Q2vIwjI7qPInS45CNutLox8fJCx4x5BAXrZjB8uNRys881HRA54KmRzdCTeq348o1DVnXo2J/poUffxELyK5TrgDJn3ZzqybnRTi5ve19I9S2HlH4MGoQ+wGys0feDPgrCkcIDm6/pNpd3EEVCxsdj69RvCTeUMoftZZRkiT4qAUKsuHGir/1of547Q/Dd6Z2KkKBrEiHbUSJIQHhYbMtdx2NIuLS7DRn9/VtW8QpySkkbPpnucCpDlhTaG65Md8to9+33yzAHjekOH5YrG1zoziZbt0ymq6JYgCMg64Gr+Gotk5j+PwIqu37T9TnqIeSim6UaznAfipXW4CmMgOvHDQj/KSfXSn0rYzW138Cw8MhoGg3bygYRBIp384UAOx9/1J3+Q0BhnYZs1TmKXPmiIul74d4DMPemVA8JhYQkB0= # MATERMOST_HOOK_URL
    - secure: u/lpB1z3eDc9uEPUm8uZI4pAw9HSOElZGjZu0lYF/aiWQuwwvNy9dZLfYkLDtDWTTDL7tTGmtEfsg9BOAX1io6qt2p140aNKYFyjvLTcHJT1PyW1eTkFyNT71WA8n4B+YxCsutDnuAVCld0nYuFaM3hjfdr+7tH/gWiIET6XhqcwxfG8zjxtNv5tTv0HTBXkVEfkddvhqj9X+Y+mg1LygHJvrDHFsr7MBudOlVVg0XIuJpxs8hV6kaKfgtWhS0CMcds3dbU+qlhXNNPox3o/LWDANxV76ngMRNs5uLd8Mld4pAetSyj0GyZxEZQ/Zkd/I5RU+2O9p5l/xJcYbrD14tDKV8vOicgCOowjPudxI5NNmMiBvw/V3fxAyZH4SxjknEfiqgGeGje9wGcPo4gW7ehvtwJ3jF3YmMgaeVJP9E3QSigLdU3cYIdbGQCAYqEl/OjNqfzoTpABVYYNs4icq22aNMkf4J111H/rKlsZnWE4L46s7sY1hdu7o63IEysT6xJYFWj8HuUQ46FjsjRePPDDG+NTiGrCBotnsDypwwPNTzJop3ftfzFA2niF+C99sTNSauN/sLhIims4jr+xPSSc4V90bZWu9FbVy7Xz1VgUoY1FfVgse+5FiJKuzTutGF7ERUtFGj48Ufi1VK4Z18es8FRkobfHPTxB5vQc3Ys= #TESTCAFE_PHOTOS_URL
    - secure: AK93m/xqCa7ihrxIMOspXXh4GZQeiCToB1VVhXHT/8EQfe0veFUqw6ZEOXsVXpgXjgzVIKVH6GnL0Y0BGp81ayuerJ9U8MR3ZJcq+mcrhX1pXb0IhYbdUf3VnGKBCNyTiv69ABvew5td6FJCGIawbKUFZ3LGwkcr+aadWOtAi1y8KJBleyjMfN90IDSAd33mX5UoVwyFr9RCVp2QzLJKqjwkHzOmOPU4mp6UPzwRNyqBVUig/bUdwgxyjChuf3mpkrWtIIpjJZPglFvakHM70qOiDDaDXwSAbUA91Kbd1KOK2niWZfPulyV0NW1O4zStIsY8vZ7176GdMlt/87XSNoGyMiLWDnq4l+gHWeoklZ3dEs3ibNBd11d29j2VLzP365p+fEi1M1HKemSZOqE2z8whrrJTu4KlLvK7Yi4YzexNEgXVtwWUEmDSYjeJZ9TqAToATKawtH7wywpswftO1uETPmAqtarKC5p4eC1RXJyfAy7DCHGVz5cKYGTMzuMMkUQeP3gv5VXobGqoadwWJIbGmkinkAjh3RSWpsLpZEqqXSnEQDpY7flFchmTNo7PNdZmdA3GLeTg8cN2MMLDeZSmhppvDWHoAjHoOix8q+W4crKH/Azzp8lITdXa1gizIDktKVOlYTg/zLfHTcsmwViMlL2kdoHELS7i+tkcfYU= #TESTCAFE_DRIVE_URL
    - secure: nx+r6bl0Rz+MmlLAR7ZM3ECIQXNhZCLVbz/PlTcbkZZ97P6xiqMpvdlOhLOK1DG3WiYGaWddiHXNL6DVaVBfZ/+ehH7Na5a1AF5NKncEhRyqGfq3JP/MOe0s0fcYDfV7ZsXNm4Y/9Smrx1QzPfHG0BKKYqmt0AMIXiGn8yx0MMSTyf5nagopPrSh2kpJ2D9vv9h3sp8486OffzF87ys7NJWcem6SXZK9tuENUKvxmX/zusdZ+sKKTGxdAmI3ANHTkbQ4A1QQRjDZ1WEl9yfiSrP4ceTgbeU6De0BVxtJYuIOpgaJrFj7ayMcH7VSM72PjOw8MieR63BOK05btiVSVWBXw+c9k0PAruhqGgkPfIU9UtJBRQwyA1o0s25+5W5tR7MSQ7v31yeCw8mDFuXp5cS9pJmMJjK1IRUIOcyUP3frpuwxKzHeXl/tCtA5xQr/cMgZpymDCme0NHUi8/hxTgsUsi9hjrHozk2L7/gQ5YjutD8M11duVpvFXMjwGAFYC/rs12ltkBa/dWff0ROtEa7zl6axGh0O1d6HblPow4jJhyKNP1llIhy2Fmfui5CKCV7i/pioMyJIFi54eKRqLRdryeElI+Go3Fp2Nklyubpg2cK4fYcLcfgsJ1eoZoyLES9Vg2Za4Cc5yXrI7RLzTfUDuU/8FLeqf7z9tk79FZw= #TESTCAFE_USER_PASSWORD
addons:
  firefox: latest
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - deadsnakes
    packages:
      - g++-4.8
      - python3.5
cache:
  yarn: true
  directories:
    - node_modules
before_install:
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then openssl aes-256-cbc -K $encrypted_b1733cb50f7f_key -iv $encrypted_b1733cb50f7f_iv -in ci-files.tar.enc -out /tmp/ci-files.tar -d; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then tar xvf /tmp/ci-files.tar -C /tmp; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then eval "$(ssh-agent -s)"; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then chmod 600 /tmp/id_rsa_travis_downcloud;
    fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" != "false" ]; then ssh-add /tmp/id_rsa_travis_downcloud;
    fi
  - curl -fsSL https://bootstrap.pypa.io/get-pip.py | python3.5 - --user
  - travis_retry pip3.5 install --user transifex-client==0.12.5
  - install -m0644 .transifexrc.tpl ~/.transifexrc
  - echo "password = $TX_PASSWD" >> ~/.transifexrc
stages:
  - prebuild
  - build
jobs:
  include:
    - name: "Lint"
      stage: "prebuild"
      script: yarn lint
    - name: "Unit tests"
      stage: "prebuild"
      script: yarn test
    - &build-web
      name: "Drive web"
      stage: "build"
      env:
        - COZY_APP_SLUG=drive
      script:
        - yarn tx
        - yarn build:$COZY_APP_SLUG:browser
        - test TRAVIS_PULL_REQUEST && yarn testcafe:$COZY_APP_SLUG || echo "skipping testcafe outside of pull requests"
      before_deploy:
        - yarn add cozy-app-publish
      deploy:
        - provider: script
          repo: cozy/cozy-drive
          skip-cleanup: true
          script: yarn run deploy:$COZY_APP_SLUG
          on:
            branch: master
        - provider: script
          repo: cozy/cozy-drive
          skip-cleanup: true
          script: yarn run deploy:$COZY_APP_SLUG
          on:
            tags: true
    - <<: *build-web
      name: "Photos web"
      env:
        - COZY_APP_SLUG=photos
sudo: required
